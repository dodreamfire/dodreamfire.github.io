<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>두드림소방 일정관리</title>
<style>
  body { font-family: 'Noto Sans KR', sans-serif; margin: 20px; background:#fafafa; }
  h1 { text-align: center; margin-bottom: 20px; }
  #authSection { text-align: center; margin-bottom: 20px; }
  #authSection button { margin: 0 10px; padding: 8px 16px; font-size: 1rem; cursor: pointer; }
  #userInfo { margin-bottom: 15px; font-weight: bold; }
  #monthSelect, textarea, button { width: 100%; margin-bottom: 10px; padding: 8px; font-size: 1rem; box-sizing: border-box; }
  #calendar { border-collapse: collapse; width: 100%; max-width: 600px; margin: 0 auto 20px; }
  #calendar th, #calendar td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; height: 100px; cursor: pointer; }
  .selected { background-color: #ffe6e6; }
  #memoList { max-width: 600px; margin: 0 auto 20px; padding-left: 0; list-style: none; }
  #memoList li { background: #fff; margin-bottom: 8px; padding: 8px; border-radius: 4px; position: relative; }
  .del-btn { position: absolute; right: 8px; top: 8px; background: #d62828; border: none; color: white; border-radius: 4px; cursor: pointer; padding: 4px 8px; }
  @media (max-width: 640px) {
    #calendar th, #calendar td { height: 80px; font-size: 0.8rem; }
  }
</style>
</head>
<body>

<h1>두드림소방 일정관리</h1>

<div id="authSection">
  <span id="userInfo"></span>
  <button id="btnLogin">로그인</button>
  <button id="btnRegister">회원가입</button>
  <button id="btnLogout" style="display:none;">로그아웃</button>
</div>

<select id="monthSelect" aria-label="월 선택"></select>

<table id="calendar" aria-label="달력"></table>

<h3>선택 날짜 메모: <span id="selectedDateDisplay">없음</span></h3>
<ul id="memoList"><li>날짜를 선택하세요.</li></ul>

<textarea id="newMemo" placeholder="새 메모 입력"></textarea>
<button id="addMemoBtn" disabled>메모 추가</button>

<div id="statusLine" style="color:green; text-align:center; margin-top:10px;"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // Firebase 초기화
  const firebaseConfig = {
    apiKey: "AIzaSyAaAeWf8x-TVUBcM8YuDYaJ1k3da0J7KXI",
    authDomain: "dodreamfire.firebaseapp.com",
    projectId: "dodreamfire",
    storageBucket: "dodreamfire.firebasestorage.app",
    messagingSenderId: "36503811647",
    appId: "1:36503811647:web:4c19ffa3dcb337dfed6a8a"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // 변수 및 요소
  const startYear = 2025, startMonth = 8;
  const endYear = 2030, endMonth = 8;

  let currentUser = null;
  let memos = {};
  let selectedDate = null;

  const monthSelect = document.getElementById('monthSelect');
  const calendar = document.getElementById('calendar');
  const memoList = document.getElementById('memoList');
  const newMemoTA = document.getElementById('newMemo');
  const addMemoBtn = document.getElementById('addMemoBtn');
  const selectedDateDisplay = document.getElementById('selectedDateDisplay');
  const statusLine = document.getElementById('statusLine');

  const userInfo = document.getElementById('userInfo');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');
  const btnLogout = document.getElementById('btnLogout');

  // 유틸 함수
  function pad(n){return n<10?'0'+n:n}
  function formatDate(y,m,d){return `${y}-${pad(m)}-${pad(d)}`}

  // 월 선택 옵션 생성
  function fillMonthSelect(){
    monthSelect.innerHTML = '';
    for(let y=startYear; y<=endYear; y++){
      let mStart = (y===startYear)? startMonth : 1;
      let mEnd = (y===endYear)? endMonth : 12;
      for(let m=mStart; m<=mEnd; m++){
        let option = document.createElement('option');
        option.value = `${y}-${pad(m)}`;
        option.textContent = `${y}년 ${m}월`;
        monthSelect.appendChild(option);
      }
    }
  }

  // 달력 그리기
  function renderCalendar(year, month) {
    calendar.innerHTML = '';
    const firstDay = new Date(year, month-1, 1);
    const lastDay = new Date(year, month, 0);
    const startDay = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    // 헤더
    const daysOfWeek = ['일','월','화','수','목','금','토'];
    let thead = document.createElement('thead');
    let trHead = document.createElement('tr');
    daysOfWeek.forEach(d => {
      let th = document.createElement('th');
      th.textContent = d;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    calendar.appendChild(thead);

    // 바디
    let tbody = document.createElement('tbody');
    let row = document.createElement('tr');
    let dayCount = 0;

    for(let i=0; i<startDay; i++){
      let td = document.createElement('td');
      row.appendChild(td);
      dayCount++;
    }

    for(let d=1; d<=daysInMonth; d++){
      if(dayCount%7 === 0){
        tbody.appendChild(row);
        row = document.createElement('tr');
      }
      let td = document.createElement('td');
      td.dataset.date = formatDate(year, month, d);
      td.style.verticalAlign = 'top';

      // 날짜 숫자 표시
      const dateNum = document.createElement('div');
      dateNum.textContent = d;
      dateNum.style.fontWeight = 'bold';
      td.appendChild(dateNum);

      // 메모들 표시
      if(memos[td.dataset.date]){
        memos[td.dataset.date].forEach(memo=>{
          let div = document.createElement('div');
          div.textContent = memo.text;
          div.style.fontSize = '0.75rem';
          div.style.backgroundColor = '#ffe6e6';
          div.style.margin = '2px 0';
          div.style.padding = '2px 4px';
          div.style.borderRadius = '4px';
          div.style.overflow = 'hidden';
          div.style.whiteSpace = 'nowrap';
          div.style.textOverflow = 'ellipsis';
          td.appendChild(div);
        });
      }

      td.addEventListener('click', () => selectDate(td.dataset.date));
      row.appendChild(td);
      dayCount++;
    }

    while(dayCount%7!==0){
      let td = document.createElement('td');
      row.appendChild(td);
      dayCount++;
    }
    tbody.appendChild(row);
    calendar.appendChild(tbody);
  }

  // 날짜 선택
  function selectDate(dateStr){
    selectedDate = dateStr;
    selectedDateDisplay.textContent = dateStr;
    highlightSelectedDate(dateStr);
    renderMemosForDate(dateStr);
  }

  // 선택한 날짜 셀 강조
  function highlightSelectedDate(dateStr){
    [...document.querySelectorAll('#calendar td')].forEach(td=>{
      td.classList.toggle('selected', td.dataset.date === dateStr);
    });
  }

  // 선택 날짜 메모 목록 렌더링
  function renderMemosForDate(dateStr){
    memoList.innerHTML = '';
    if(!memos[dateStr] || memos[dateStr].length === 0){
      memoList.innerHTML = '<li>메모가 없습니다.</li>';
      return;
    }
    memos[dateStr].forEach((memo, idx) => {
      let li = document.createElement('li');
      li.textContent = memo.text;
      let delBtn = document.createElement('button');
      delBtn.textContent = '삭제';
      delBtn.className = 'del-btn';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        deleteMemo(dateStr, idx);
      };
      li.appendChild(delBtn);
      memoList.appendChild(li);
    });
  }

  // 메모 추가
  async function addMemo(){
    if(!currentUser){
      alert('로그인 후 이용해주세요.');
      return;
    }
    if(!selectedDate){
      alert('날짜를 선택해주세요.');
      return;
    }
    const text = newMemoTA.value.trim();
    if(!text){
      alert('메모 내용을 입력해주세요.');
      return;
    }
    try {
      await db.collection('memos').add({
        uid: currentUser.uid,
        date: selectedDate,
        text: text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      newMemoTA.value = '';
      statusLine.textContent = '메모가 저장되었습니다.';
      await loadMemos();
      renderMemosForDate(selectedDate);
    } catch(e){
      console.error(e);
      alert('메모 저장 중 오류가 발생했습니다.');
    }
  }

  // 메모 삭제
  async function deleteMemo(dateStr, idx){
    if(!currentUser) return;
    const memoArr = memos[dateStr];
    if(!memoArr || !memoArr[idx]) return;
    const memo = memoArr[idx];
    if(memo.uid !== currentUser.uid) {
      alert('본인 메모만 삭제할 수 있습니다.');
      return;
    }
    try {
      await db.collection('memos').doc(memo.id).delete();
      statusLine.textContent = '메모가 삭제되었습니다.';
      await loadMemos();
      renderMemosForDate(selectedDate);
    } catch(e){
      console.error(e);
      alert('삭제 실패');
    }
  }

  // 모든 메모 불러오기 (로그인 사용자 기준)
  async function loadMemos(){
    if(!currentUser){
      memos = {};
      renderCalendarDisplay();
      renderMemosForDate(selectedDate);
      return;
    }
    try {
      const snapshot = await db.collection('memos')
        .where('uid', '==', currentUser.uid)
        .get();

      memos = {};
      snapshot.forEach(doc=>{
        const data = doc.data();
        data.id = doc.id;
        if(!memos[data.date]) memos[data.date] = [];
        memos[data.date].push(data);
      });
      renderCalendarDisplay();
      if(selectedDate) renderMemosForDate(selectedDate);
    } catch(e){
      console.error(e);
    }
  }

  // 달력 다시 그리기
  function renderCalendarDisplay(){
    if(!monthSelect.value) return;
    const [y,m] = monthSelect.value.split('-').map(Number);
    renderCalendar(y,m);
    if(selectedDate && selectedDate.startsWith(monthSelect.value)){
      highlightSelectedDate(selectedDate);
    } else {
      selectedDate = null;
      memoList.innerHTML = '<li>날짜를 선택하세요.</li>';
      selectedDateDisplay.textContent = '없음';
    }
  }

  // 인증 상태 UI 갱신
  function updateAuthUI(user){
    currentUser = user;
    if(user){
      userInfo.textContent = `${user.email}님 환영합니다.`;
      btnLogin.style.display = 'none';
      btnRegister.style.display = 'none';
      btnLogout.style.display = 'inline-block';
      addMemoBtn.disabled = false;
      loadMemos();
    } else {
      userInfo.textContent = '로그인 해주세요.';
      btnLogin.style.display = 'inline-block';
      btnRegister.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      addMemoBtn.disabled = true;
      memos = {};
      renderCalendarDisplay();
      memoList.innerHTML = '<li>날짜를 선택하세요.</li>';
      selectedDateDisplay.textContent = '없음';
      statusLine.textContent = '';
    }
  }

  // 이벤트 핸들러 연결
  btnLogin.onclick = async () => {
    const email = prompt('이메일 입력');
    if(!email) return alert('이메일이 필요합니다.');
    const password = prompt('비밀번호 입력');
    if(!password) return alert('비밀번호가 필요합니다.');
    try {
      await auth.signInWithEmailAndPassword(email, password);
      statusLine.textContent = '로그인 성공!';
    } catch(e) {
      alert('로그인 실패: ' + e.message);
    }
  };

  btnRegister.onclick = async () => {
    const email = prompt('회원가입용 이메일 입력');
    if(!email) return alert('이메일이 필요합니다.');
    const password = prompt('비밀번호 입력 (6자 이상)');
    if(!password || password.length < 6) return alert('6자 이상의 비밀번호가 필요합니다.');
    try {
      await auth.createUserWithEmailAndPassword(email, password);
      statusLine.textContent = '회원가입 및 로그인 성공!';
    } catch(e) {
      alert('회원가입 실패: ' + e.message);
    }
  };

  btnLogout.onclick = async () => {
    try {
      await auth.signOut();
      statusLine.textContent = '로그아웃 되었습니다.';
    } catch(e) {
      alert('로그아웃 실패: ' + e.message);
    }
  };

  monthSelect.onchange = () => {
    renderCalendarDisplay();
  };

  addMemoBtn.onclick = addMemo;

  // 초기 실행
  fillMonthSelect();
  monthSelect.value = `${startYear}-${pad(startMonth)}`;
  renderCalendarDisplay();

  auth.onAuthStateChanged(user => {
    updateAuthUI(user);
  });
</script>

</body>
</html>
