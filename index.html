<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>두드림소방 일정관리</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap');
  body {
    font-family: 'Noto Sans KR', sans-serif;
    margin: 0;
    background: #f9f9f9;
    color: #333;
  }
  header {
    background: #d62828;
    color: white;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  header .logo {
    display: flex;
    align-items: center;
  }
  header .logo img {
    height: 40px;
    margin-right: 12px;
  }
  header h1 {
    font-size: 1.5rem;
    margin: 0;
    font-weight: 700;
  }
  #authSection {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #authSection button {
    background: white;
    border: none;
    color: #d62828;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.3s ease;
  }
  #authSection button:hover {
    background: #efefef;
  }
  #userInfo {
    color: white;
    font-weight: 600;
  }
  main {
    max-width: 720px;
    margin: 20px auto;
    padding: 0 15px;
  }
  #monthSelect, textarea, button {
    width: 100%;
    margin-bottom: 12px;
    padding: 10px;
    font-size: 1rem;
    box-sizing: border-box;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-family: 'Noto Sans KR', sans-serif;
  }
  textarea {
    resize: vertical;
    min-height: 80px;
  }
  #addMemoBtn {
    background-color: #d62828;
    border: none;
    color: white;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #addMemoBtn:disabled {
    background-color: #aaa;
    cursor: not-allowed;
  }
  #addMemoBtn:hover:not(:disabled) {
    background-color: #b02020;
  }
  table#calendar {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 20px;
    table-layout: fixed;
  }
  #calendar th, #calendar td {
    border: 1px solid #ddd;
    padding: 6px;
    vertical-align: top;
    height: 90px;
    cursor: pointer;
    overflow: hidden;
  }
  #calendar th {
    background-color: #f1f1f1;
  }
  #calendar td.selected {
    background-color: #ffe6e6;
  }
  #calendar td div.date-num {
    font-weight: 700;
    margin-bottom: 6px;
  }
  #calendar td div.memo-item {
    background-color: #ffcccc;
    font-size: 0.75rem;
    padding: 2px 5px;
    margin-bottom: 2px;
    border-radius: 4px;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }
  #memoList {
    list-style: none;
    padding-left: 0;
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: white;
  }
  #memoList li {
    padding: 10px 40px 10px 12px;
    border-bottom: 1px solid #eee;
    position: relative;
    font-size: 0.95rem;
  }
  #memoList li:last-child {
    border-bottom: none;
  }
  #memoList button.del-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: #d62828;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 4px;
    cursor: pointer;
    line-height: 1;
  }
  #memoList button.del-btn:hover {
    background: #a82020;
  }
  #statusLine {
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
    min-height: 20px;
    color: green;
  }
  @media(max-width: 480px){
    header {
      flex-wrap: wrap;
      gap: 10px;
    }
    #authSection {
      width: 100%;
      justify-content: center;
    }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="두드림소방로고.PNG" alt="두드림소방 로고" />
    <h1>두드림소방 일정관리</h1>
  </div>
  <div id="authSection">
    <span id="userInfo"></span>
    <button id="btnLogin">로그인</button>
    <button id="btnRegister">회원가입</button>
    <button id="btnLogout" style="display:none;">로그아웃</button>
  </div>
</header>

<main>
  <select id="monthSelect" aria-label="월 선택"></select>

  <table id="calendar" aria-label="달력"></table>

  <h3>선택 날짜 메모: <span id="selectedDateDisplay">없음</span></h3>
  <ul id="memoList"><li>날짜를 선택하세요.</li></ul>

  <textarea id="newMemo" placeholder="새 메모 입력"></textarea>
  <button id="addMemoBtn" disabled>메모 추가</button>

  <div id="statusLine"></div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAaAeWf8x-TVUBcM8YuDYaJ1k3da0J7KXI",
    authDomain: "dodreamfire.firebaseapp.com",
    projectId: "dodreamfire",
    storageBucket: "dodreamfire.firebasestorage.app",
    messagingSenderId: "36503811647",
    appId: "1:36503811647:web:4c19ffa3dcb337dfed6a8a"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const startYear = 2025, startMonth = 8;
  const endYear = 2030, endMonth = 8;

  let currentUser = null;
  let memos = {};
  let selectedDate = null;

  const monthSelect = document.getElementById('monthSelect');
  const calendar = document.getElementById('calendar');
  const memoList = document.getElementById('memoList');
  const newMemoTA = document.getElementById('newMemo');
  const addMemoBtn = document.getElementById('addMemoBtn');
  const selectedDateDisplay = document.getElementById('selectedDateDisplay');
  const statusLine = document.getElementById('statusLine');

  const userInfo = document.getElementById('userInfo');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');
  const btnLogout = document.getElementById('btnLogout');

  function pad(n){return n<10?'0'+n:n}
  function formatDate(y,m,d){return `${y}-${pad(m)}-${pad(d)}`}

  function fillMonthSelect(){
    monthSelect.innerHTML = '';
    for(let y=startYear; y<=endYear; y++){
      let mStart = (y===startYear)? startMonth : 1;
      let mEnd = (y===endYear)? endMonth : 12;
      for(let m=mStart; m<=mEnd; m++){
        let option = document.createElement('option');
        option.value = `${y}-${pad(m)}`;
        option.textContent = `${y}년 ${m}월`;
        monthSelect.appendChild(option);
      }
    }
  }

  function renderCalendar(year, month) {
    calendar.innerHTML = '';
    const firstDay = new Date(year, month-1, 1);
    const lastDay = new Date(year, month, 0);
    const startDay = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    const daysOfWeek = ['일','월','화','수','목','금','토'];
    let thead = document.createElement('thead');
    let trHead = document.createElement('tr');
    daysOfWeek.forEach(d => {
      let th = document.createElement('th');
      th.textContent = d;
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);
    calendar.appendChild(thead);

    let tbody = document.createElement('tbody');
    let row = document.createElement('tr');
    let dayCount = 0;

    for(let i=0; i<startDay; i++){
      let td = document.createElement('td');
      row.appendChild(td);
      dayCount++;
    }

    for(let d=1; d<=daysInMonth; d++){
      if(dayCount%7 === 0){
        tbody.appendChild(row);
        row = document.createElement('tr');
      }
      let td = document.createElement('td');
      td.dataset.date = formatDate(year, month, d);
      td.style.verticalAlign = 'top';

      const dateNum = document.createElement('div');
      dateNum.textContent = d;
      dateNum.className = 'date-num';
      td.appendChild(dateNum);

      if(memos[td.dataset.date]){
        memos[td.dataset.date].forEach(memo=>{
          let div = document.createElement('div');
          div.textContent = memo.text;
          div.className = 'memo-item';
          td.appendChild(div);
        });
      }

      td.addEventListener('click', () => selectDate(td.dataset.date));
      row.appendChild(td);
      dayCount++;
    }

    while(dayCount%7!==0){
      let td = document.createElement('td');
      row.appendChild(td);
      dayCount++;
    }
    tbody.appendChild(row);
    calendar.appendChild(tbody);
  }

  function selectDate(dateStr){
    selectedDate = dateStr;
    selectedDateDisplay.textContent = dateStr;
    highlightSelectedDate(dateStr);
    renderMemosForDate(dateStr);
  }

  function highlightSelectedDate(dateStr){
    [...document.querySelectorAll('#calendar td')].forEach(td=>{
      td.classList.toggle('selected', td.dataset.date === dateStr);
    });
  }

  function renderMemosForDate(dateStr){
    memoList.innerHTML = '';
    if(!memos[dateStr] || memos[dateStr].length === 0){
      memoList.innerHTML = '<li>메모가 없습니다.</li>';
      return;
    }
    memos[dateStr].forEach((memo, idx) => {
      let li = document.createElement('li');
      li.textContent = memo.text;
      let delBtn = document.createElement('button');
      delBtn.textContent = '삭제';
      delBtn.className = 'del-btn';
      delBtn.title = "삭제";
      delBtn.onclick = (e) => {
        e.stopPropagation();
        deleteMemo(dateStr, idx);
      };
      li.appendChild(delBtn);
      memoList.appendChild(li);
    });
  }

  async function loadMemos() {
    if(!currentUser) return;
    memos = {};
    const snapshot = await db.collection('memos')
      .where('uid', '==', currentUser.uid)
      .get();
    snapshot.forEach(doc => {
      const data = doc.data();
      if(!memos[data.date]) memos[data.date] = [];
      memos[data.date].push({id: doc.id, text: data.text});
    });
    renderCalendarDisplay();
    if(selectedDate) renderMemosForDate(selectedDate);
  }

  async function addMemo(){
    if(!currentUser) {
      alert('로그인 후 이용해 주세요.');
      return;
    }
    if(!selectedDate) {
      alert('날짜를 선택해 주세요.');
      return;
    }
    const text = newMemoTA.value.trim();
    if(text==='') {
      alert('메모를 입력해 주세요.');
      return;
    }
    try {
      const docRef = await db.collection('memos').add({
        uid: currentUser.uid,
        date: selectedDate,
        text: text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      if(!memos[selectedDate]) memos[selectedDate] = [];
      memos[selectedDate].push({id: docRef.id, text});
      newMemoTA.value = '';
      renderCalendarDisplay();
      renderMemosForDate(selectedDate);
      statusLine.textContent = '메모가 추가되었습니다.';
      setTimeout(() => statusLine.textContent = '', 3000);
    } catch(e){
      alert('메모 추가 중 오류가 발생했습니다: ' + e.message);
    }
  }

  async function deleteMemo(dateStr, idx){
    if(!currentUser) {
      alert('로그인 후 이용해 주세요.');
      return;
    }
    const memo = memos[dateStr][idx];
    if(!memo || !memo.id) return;
    try {
      await db.collection('memos').doc(memo.id).delete();
      memos[dateStr].splice(idx,1);
      if(memos[dateStr].length===0) delete memos[dateStr];
      renderCalendarDisplay();
      if(selectedDate === dateStr) renderMemosForDate(dateStr);
      statusLine.textContent = '메모가 삭제되었습니다.';
      setTimeout(() => statusLine.textContent = '', 3000);
    } catch(e){
      alert('메모 삭제 중 오류가 발생했습니다: ' + e.message);
    }
  }

  function updateAuthUI(user){
    currentUser = user;
    if(user){
      userInfo.textContent = user.email;
      btnLogin.style.display = 'none';
      btnRegister.style.display = 'none';
      btnLogout.style.display = 'inline-block';
      addMemoBtn.disabled = false;
    } else {
      userInfo.textContent = '';
      btnLogin.style.display = 'inline-block';
      btnRegister.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      addMemoBtn.disabled = true;
      memos = {};
      renderCalendarDisplay();
      memoList.innerHTML = '<li>로그인 후 메모를 사용할 수 있습니다.</li>';
      selectedDateDisplay.textContent = '없음';
      selectedDate = null;
    }
  }

  btnLogin.onclick = async () => {
    const email = prompt('이메일 입력');
    if(!email) return alert('이메일이 필요합니다.');
    const password = prompt('비밀번호 입력 (6자 이상)');
    if(!password || password.length < 6) return alert('6자 이상의 비밀번호가 필요합니다.');
    try {
      await auth.signInWithEmailAndPassword(email, password);
      statusLine.textContent = '로그인 성공!';
    } catch(e) {
      alert('로그인 실패: ' + e.message);
    }
  };

  btnRegister.onclick = async () => {
    const email = prompt('회원가입용 이메일 입력');
    if(!email) return alert('이메일이 필요합니다.');
    const password = prompt('비밀번호 입력 (6자 이상)');
    if(!password || password.length < 6) return alert('6자 이상의 비밀번호가 필요합니다.');
    try {
      await auth.createUserWithEmailAndPassword(email, password);
      statusLine.textContent = '회원가입 및 로그인 성공!';
    } catch(e) {
      alert('회원가입 실패: ' + e.message);
    }
  };

  btnLogout.onclick = async () => {
    try {
      await auth.signOut();
      statusLine.textContent = '로그아웃 되었습니다.';
    } catch(e) {
      alert('로그아웃 실패: ' + e.message);
    }
  };

  monthSelect.onchange = () => {
    renderCalendarDisplay();
  };

  addMemoBtn.onclick = addMemo;

  function renderCalendarDisplay(){
    if(!monthSelect.value) return;
    const [y,m] = monthSelect.value.split('-').map(Number);
    renderCalendar(y,m);
  }

  function init(){
    fillMonthSelect();
    monthSelect.value = `${startYear}-${pad(startMonth)}`;
    renderCalendarDisplay();
    updateAuthUI(null);

    auth.onAuthStateChanged(user => {
      updateAuthUI(user);
      if(user){
        loadMemos();
      }
    });
  }

  init();
</script>

</body>
</html>
