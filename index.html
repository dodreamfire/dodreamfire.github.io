<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>두드림소방 일정관리</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="dodreamfirelogo.PNG" type="image/png">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    header { display: flex; align-items: center; background: #005cbf; color: white; padding: 10px; }
    header img { height: 40px; margin-right: 10px; }
    header h1 { font-size: 1.5rem; margin: 0; }
    .container { padding: 20px; max-width: 900px; margin: auto; }

    /* 요일 */
    .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; font-weight: bold; text-align: center; margin-bottom: 5px; }
    .calendar-header div { background: #005cbf; color: white; padding: 5px 0; border-radius: 3px; }

    .month-selector { margin-bottom: 20px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .day { background: white; padding: 10px; border: 1px solid #ccc; min-height: 80px; position: relative; cursor: pointer; }
    .day:hover { background: #e6f0ff; }
    .day .day-number { font-weight: bold; margin-bottom: 5px; }
    .memo { background: #f0f8ff; padding: 2px 5px; margin-bottom: 3px; font-size: 0.8rem; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .memo button { background: red; color: white; border: none; font-size: 0.7rem; padding: 0 4px; border-radius: 3px; cursor: pointer; }

    /* 모달 */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; width: 90%; max-width: 500px; border-radius: 5px; }
    .modal-content h2 { margin-top: 0; }
    .modal-content textarea { width: 100%; height: 100px; margin-bottom: 10px; }
    .modal-content button { margin-right: 10px; padding: 5px 10px; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <img src="dodreamfirelogo.PNG" alt="두드림소방 로고">
    <h1>두드림소방 일정관리</h1>
  </header>
  <div class="container">
    <div class="month-selector">
      <label for="month">월 선택: </label>
      <input type="month" id="month" min="2025-08" max="2030-08">
    </div>
    <div class="calendar-header">
      <div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div><div>일</div>
    </div>
    <div class="calendar" id="calendar"></div>
  </div>

  <!-- 모달 -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h2 id="modal-date"></h2>
      <textarea id="memo-text" placeholder="메모 내용을 입력하세요"></textarea>
      <button id="save-memo">저장</button>
      <button id="close-modal">닫기</button>
      <div id="memo-list"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyAaAeWf8x-TVUBcM8YuDYaJ1k3da0J7KXI",
      authDomain: "dodreamfire.firebaseapp.com",
      projectId: "dodreamfire",
      storageBucket: "dodreamfire.appspot.com",
      messagingSenderId: "36503811647",
      appId: "1:36503811647:web:4c19ffa3dcb337dfed6a8a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const monthInput = document.getElementById('month');
    const today = new Date();
    monthInput.value = today.toISOString().substring(0,7);

    const calendar = document.getElementById('calendar');
    const modal = document.getElementById('modal');
    const modalDate = document.getElementById('modal-date');
    const memoText = document.getElementById('memo-text');
    const memoList = document.getElementById('memo-list');
    let selectedDate = null;
    let selectedMemoId = null;

    function renderCalendar(year, month) {
      calendar.innerHTML = '';
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month+1, 0).getDate();

      for(let i=0;i<firstDay;i++){
        const empty = document.createElement('div');
        calendar.appendChild(empty);
      }

      for(let d=1; d<=lastDate; d++){
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('day');
        dayDiv.innerHTML = `<div class="day-number">${d}</div>`;
        calendar.appendChild(dayDiv);

        const dateStr = `${year}-${month+1}-${d}`;
        db.collection('memos').where('year','==',year).where('month','==',month).where('day','==',d)
          .get()
          .then(snapshot=>{
            snapshot.forEach(doc=>{
              const data = doc.data();
              const memoDiv = document.createElement('div');
              memoDiv.classList.add('memo');
              memoDiv.textContent = data.text;

              const delBtn = document.createElement('button');
              delBtn.textContent = 'X';
              delBtn.onclick = e=>{
                e.stopPropagation();
                db.collection('memos').doc(doc.id).delete();
                memoDiv.remove();
              };
              memoDiv.appendChild(delBtn);

              // 세부메모 클릭
              memoDiv.onclick = e=>{
                e.stopPropagation();
                modal.style.display = 'flex';
                memoText.value = data.text;
                selectedDate = {year, month, day:d};
                modalDate.textContent = `${year}-${month+1}-${d}`;
                selectedMemoId = doc.id;
                loadMemoList(year, month, d);
              };

              dayDiv.appendChild(memoDiv);
            });
          });

        dayDiv.onclick = ()=>{
          selectedDate = {year, month, day:d};
          modalDate.textContent = `${year}-${month+1}-${d}`;
          memoText.value = '';
          selectedMemoId = null;
          loadMemoList(year, month, d);
          modal.style.display = 'flex';
        };
      }
    }

    function loadMemoList(year, month, day){
      memoList.innerHTML = '';
      db.collection('memos').where('year','==',year).where('month','==',month).where('day','==',day)
        .get()
        .then(snapshot=>{
          snapshot.forEach(doc=>{
            const data = doc.data();
            const item = document.createElement('div');
            item.classList.add('memo');
            item.textContent = data.text;

            const delBtn = document.createElement('button');
            delBtn.textContent = 'X';
            delBtn.onclick = e=>{
              e.stopPropagation();
              db.collection('memos').doc(doc.id).delete();
              item.remove();
            };
            item.appendChild(delBtn);

            // 세부메모 클릭
            item.onclick = e=>{
              e.stopPropagation();
              memoText.value = data.text;
              selectedMemoId = doc.id;
            };

            memoList.appendChild(item);
          });
        });
    }

    document.getElementById('close-modal').onclick = ()=>{ modal.style.display = 'none'; };

    document.getElementById('save-memo').onclick = ()=>{
      if(!memoText.value.trim()) return;
      if(selectedMemoId){ // 기존 메모 수정
        db.collection('memos').doc(selectedMemoId).update({
          text: memoText.value.trim()
        }).then(()=>{
          renderCalendar(selectedDate.year, selectedDate.month);
          selectedMemoId = null;
          memoText.value = '';
        });
      } else { // 새 메모 추가
        db.collection('memos').add({
          year:selectedDate.year,
          month:selectedDate.month,
          day:selectedDate.day,
          text:memoText.value.trim()
        }).then(()=>{
          renderCalendar(selectedDate.year, selectedDate.month);
          memoText.value = '';
        });
      }
    };

    monthInput.addEventListener('change',()=>{
      const [y,m] = monthInput.value.split('-');
      renderCalendar(parseInt(y), parseInt(m)-1);
    });

    // 초기 렌더
    renderCalendar(today.getFullYear(), today.getMonth());

    // PWA 서비스워커 등록
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>
</html>
